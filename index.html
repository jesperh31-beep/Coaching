<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Floorball Coach - Planlægning</title>
  <style>
    :root{--accent:#2b6cb0;--muted:#666}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0;padding:0;color:#111}
    header{background:var(--accent);color:white;padding:1rem 1.2rem}
    .container{display:flex;gap:1rem;padding:1rem}
    .col{background:#fff;border:1px solid #eee;padding:1rem;border-radius:6px}
    .col.small{width:220px}
    .col.large{flex:1}
    h2{margin:0 0 .5rem 0}
    label{display:block;font-size:.9rem;margin-top:.5rem}
    input[type=text],select,textarea{width:100%;padding:.4rem;margin-top:.25rem;border:1px solid #ddd;border-radius:4px}
    button{background:var(--accent);color:white;border:none;padding:.4rem .6rem;border-radius:4px;cursor:pointer}
    .players-list, .ex-list{max-height:300px;overflow:auto;margin-top:.5rem}
    .player-item, .ex-item{padding:.4rem;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;gap:.5rem}
    .ex-item img{width:80px;height:60px;object-fit:cover;border-radius:4px;cursor:pointer}
    .ex-controls{margin-left:auto;display:flex;gap:.25rem}
    .muted{color:var(--muted);font-size:.9rem}
    .small-btn{padding:.2rem .4rem;background:#eee;color:#333;border-radius:4px;border:1px solid #ddd}
    .group-badge{background:#f7fafc;border:1px solid #e2e8f0;padding:.15rem .4rem;border-radius:12px;font-size:.8rem}

    /* Modal */
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
    .modal .card{background:white;padding:1rem;border-radius:8px;max-width:900px;width:95%;max-height:85%;overflow:auto}
    .modal.show{display:flex}

    /* Print styles */
    @media print{
      body{background:white;color:black}
      header, .no-print{display:none}
      .container{display:block;padding:0}
      .print-header{display:block;margin:0 0 1rem 0}
      .print-equipment{font-weight:700;margin-bottom:.5rem}
      .ex-item img{width:100%;height:auto;display:block;margin:0 0 .5rem 0}
      .ex-item{page-break-inside:avoid;padding:0;margin-bottom:1rem;border:none}
      .col{border:none;padding:0}
    }

    /* screen layout adjustments */
    .top-actions{display:flex;gap:.5rem;align-items:center}
    .ex-img-large{max-width:100%;height:auto}
    .chain-table{width:100%;border-collapse:collapse}
    .chain-table th,.chain-table td{border:1px solid #eee;padding:.4rem;text-align:left}

  </style>
</head>
<body>
  <header>
    <h1>Floorball Coach - Planlægning</h1>
  </header>

  <div style="padding:1rem">
    <div class="top-actions">
      <button id="printBtn">Print plan</button>
      <button id="openMatchBtn">Opret kamp</button>
      <div style="margin-left:auto" class="muted">Din side gemmer i din browser (lokalt). Husk at commit/push til GitHub for at gemme i repo.</div>
    </div>

    <div class="container">
      <div class="col small">
        <h2>Spillere</h2>
        <label>Tilføj spiller</label>
        <input id="playerName" type="text" placeholder="Navn" />
        <button id="addPlayerBtn">Tilføj</button>
        <div class="players-list" id="playersList"></div>
      </div>

      <div class="col large">
        <h2>Øvelser</h2>
        <label>Tilføj øvelse (vælg type eller frit tekst)</label>
        <select id="exType">
          <option value="drill">Standard øvelse</option>
          <option value="free">Fritekst</option>
        </select>
        <input id="exTitle" type="text" placeholder="Titel eller fritekst" />
        <label>Billede URL (valgfri)</label>
        <input id="exImage" type="text" placeholder="https://..." />
        <label>Redskaber (komma-separeret)</label>
        <input id="exEquip" type="text" placeholder="Kegler, bolde" />
        <label><input id="exGroups" type="checkbox" /> Kræver grupper (del deltagerne op)</label>
        <button id="addExBtn">Tilføj øvelse</button>

        <div class="ex-list" id="exList"></div>
      </div>
    </div>
  </div>

  <!-- Image modal -->
  <div class="modal" id="imgModal">
    <div class="card">
      <button id="closeImgModal" style="float:right" class="small-btn">Luk</button>
      <img id="modalImg" src="" alt="Billede" style="max-width:100%;display:block;margin:1rem auto}" />
    </div>
  </div>

  <!-- Groups modal -->
  <div class="modal" id="groupsModal">
    <div class="card">
      <h3>Fordel spillere i grupper</h3>
      <div id="groupsContent"></div>
      <div style="margin-top:.5rem"><button id="saveGroupsBtn">Gem grupper</button> <button id="closeGroupsModal" class="small-btn">Luk</button></div>
    </div>
  </div>

  <!-- Match modal -->
  <div class="modal" id="matchModal">
    <div class="card">
      <h2>Opret kamp</h2>
      <label>Vælg spillere (klik for at tilføje til en kæde)</label>
      <div style="display:flex;gap:1rem">
        <div style="flex:1">
          <h3>Tilgængelige spillere</h3>
          <div id="matchAvailablePlayers"></div>
        </div>
        <div style="flex:2">
          <h3>Kæder</h3>
          <div id="chainsContainer"></div>
        </div>
      </div>
      <div style="margin-top:1rem">
        <button id="saveMatchBtn">Gem kamp</button>
        <button id="closeMatchModal" class="small-btn">Luk</button>
      </div>
    </div>
  </div>

  <script>
    // Data model stored in localStorage
    const STORAGE_KEY = 'fcoach-data-v1';
    let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    state.players = state.players || [];
    state.exercises = state.exercises || [];
    state.matches = state.matches || [];

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // Players
    const playersListEl = document.getElementById('playersList');
    function renderPlayers(){
      playersListEl.innerHTML = '';
      state.players.forEach((p, i) => {
        const div = document.createElement('div'); div.className='player-item';
        div.innerHTML = `<div>${p.name}</div><div style="margin-left:auto">`+
          `<button class="small-btn" data-i="${i}" onclick="removePlayer(${i})">Fjern</button>`+
          `</div>`;
        playersListEl.appendChild(div);
      });
    }
    window.removePlayer = function(i){ state.players.splice(i,1); save(); renderPlayers(); renderExList(); }

    document.getElementById('addPlayerBtn').addEventListener('click', ()=>{
      const name = document.getElementById('playerName').value.trim();
      if(!name) return alert('Skriv et navn');
      state.players.push({name});
      document.getElementById('playerName').value=''; save(); renderPlayers(); renderExList(); renderMatchAvailable();
    });

    // Exercises
    const exListEl = document.getElementById('exList');
    function renderExList(){
      exListEl.innerHTML='';
      state.exercises.forEach((ex, idx) => {
        const div = document.createElement('div'); div.className='ex-item';
        const imgHtml = ex.image ? `<img src="${ex.image}" alt="" onclick="openImage('${ex.image}')"/>` : '';
        const equipBadge = ex.equipment && ex.equipment.length ? `<div class="muted">Redskaber: ${ex.equipment.join(', ')}</div>` : '';
        const groupsBadge = ex.groups ? `<span class="group-badge">Grupper</span>` : '';
        div.innerHTML = `${imgHtml}<div style="flex:1"><strong>${escapeHtml(ex.title)}</strong><div class="muted">${ex.type}</div>${equipBadge}</div>`+
          `<div class="ex-controls">`+
          `<button class="small-btn" onclick="moveUp(${idx})">▲</button>`+
          `<button class="small-btn" onclick="moveDown(${idx})">▼</button>`+
          (ex.groups? `<button class="small-btn" onclick="openGroups(${idx})">Grupper</button>` : '')+
          `<button class="small-btn" onclick="removeEx(${idx})">Fjern</button>`+
          `</div>`;
        exListEl.appendChild(div);
      });
    }

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    document.getElementById('addExBtn').addEventListener('click', ()=>{
      const type = document.getElementById('exType').value;
      const title = document.getElementById('exTitle').value.trim();
      if(!title) return alert('Skriv titel eller fritekst');
      const image = document.getElementById('exImage').value.trim();
      const eq = document.getElementById('exEquip').value.split(',').map(s=>s.trim()).filter(Boolean);
      const groups = document.getElementById('exGroups').checked;
      state.exercises.push({type, title, image, equipment: eq, groups, grouping: groups ? {} : null});
      document.getElementById('exTitle').value=''; document.getElementById('exImage').value=''; document.getElementById('exEquip').value=''; document.getElementById('exGroups').checked=false;
      save(); renderExList();
    });

    window.removeEx = function(i){ if(confirm('Vil du fjerne øvelsen?')){ state.exercises.splice(i,1); save(); renderExList(); } }
    window.moveUp = function(i){ if(i<=0) return; const a=state.exercises; [a[i-1],a[i]]=[a[i],a[i-1]]; save(); renderExList(); }
    window.moveDown = function(i){ const a=state.exercises; if(i>=a.length-1) return; [a[i+1],a[i]]=[a[i],a[i+1]]; save(); renderExList(); }

    // Image modal
    const imgModal = document.getElementById('imgModal');
    function openImage(src){ document.getElementById('modalImg').src=src; imgModal.classList.add('show'); }
    document.getElementById('closeImgModal').addEventListener('click', ()=>{ imgModal.classList.remove('show'); });

    // Groups modal
    let currentGroupIndex = null;
    function openGroups(i){ currentGroupIndex = i; const ex = state.exercises[i]; const content = document.getElementById('groupsContent');
      content.innerHTML='';
      if(!state.players.length) { content.innerHTML='<div>Ingen spillere. Tilføj spillere først.</div>'; }
      state.players.forEach((p,pi)=>{
        const val = ex.grouping && ex.grouping[pi] ? ex.grouping[pi] : '';
        const row = document.createElement('div');
        row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.marginBottom='6px';
        row.innerHTML = `<div style="flex:1">${p.name}</div><input data-pi="${pi}" placeholder="Gruppe (fx 1 eller A)" value="${val}" />`;
        content.appendChild(row);
      });
      document.getElementById('groupsModal').classList.add('show');
    }
    document.getElementById('closeGroupsModal').addEventListener('click', ()=>{ document.getElementById('groupsModal').classList.remove('show'); });
    document.getElementById('saveGroupsBtn').addEventListener('click', ()=>{
      const inputs = document.querySelectorAll('#groupsContent input');
      const mapping = {};
      inputs.forEach(inp => { const pi = inp.getAttribute('data-pi'); const v = inp.value.trim(); if(v) mapping[pi]=v; });
      state.exercises[currentGroupIndex].grouping = mapping; save(); renderExList(); document.getElementById('groupsModal').classList.remove('show');
    });

    // Print
    document.getElementById('printBtn').addEventListener('click', ()=>{ preparePrint(); window.print(); });
    function preparePrint(){
      // collect equipment list
      const allEq = new Set();
      state.exercises.forEach(ex => (ex.equipment||[]).forEach(e => allEq.add(e)));
      const eqArr = Array.from(allEq);
      // insert a print header element
      let ph = document.querySelector('.print-header');
      if(!ph){ ph = document.createElement('div'); ph.className='print-header'; document.body.insertBefore(ph, document.body.firstChild); }
      ph.innerHTML = `<div class="print-equipment">Redskaber: ${eqArr.join(', ')}</div>`;
    }

    // Match modal and chains
    const chains = ['1. kæde','2. kæde','3. kæde','Reserver','startende målmand','PowerPlay','BoxPlay'];
    function renderMatchAvailable(){
      const el = document.getElementById('matchAvailablePlayers'); el.innerHTML='';
      state.players.forEach((p,i)=>{
        const btn = document.createElement('button'); btn.textContent=p.name; btn.className='small-btn'; btn.style.margin='4px'; btn.onclick = ()=> addToChainSelection(i);
        el.appendChild(btn);
      });
    }
    const matchSelection = {};
    function renderChains(){
      const ccont = document.getElementById('chainsContainer'); ccont.innerHTML='';
      chains.forEach((c,ci)=>{
        const box = document.createElement('div'); box.style.marginBottom='8px';
        box.innerHTML = `<h4>${c}</h4><div id="chain-${ci}" style="min-height:40px;border:1px dashed #eee;padding:6px"></div>`;
        ccont.appendChild(box);
        const chainEl = document.getElementById(`chain-${ci}`);
        (matchSelection[c]||[]).forEach(ms=>{
          const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px';
          row.innerHTML = `<div style="flex:1">${state.players[ms.idx].name}</div>`+
            `<select data-ci="${ci}" data-idx="${ms.idx}">`+
            `<option value="LD">LD</option><option value="RD">RD</option><option value="LW">LW</option><option value="C">C</option><option value="RW">RW</option></select>`+
            `<button class="small-btn" onclick="removeFromChain(${ci},${ms.idx})">Fjern</button>`;
          chainEl.appendChild(row);
        });
        // set positions to previously selected
        (chainEl.querySelectorAll('select')||[]).forEach(sel=>{ if(sel.getAttribute('data-pos')) sel.value = sel.getAttribute('data-pos'); });
      });
    }
    function addToChainSelection(playerIdx){
      const chainName = prompt('Tilføj til hvilken kæde?\nSkriv: 1,2,3,Reserver,Start,PP,Box (fx 1 for 1. kæde)');
      if(!chainName) return;
      let target = null;
      if(chainName==='1') target='1. kæde'; else if(chainName==='2') target='2. kæde'; else if(chainName==='3') target='3. kæde';
      else if(chainName.toLowerCase()==='reserver') target='Reserver'; else if(chainName.toLowerCase()==='start') target='startende målmand';
      else if(chainName.toLowerCase()==='pp') target='PowerPlay'; else if(chainName.toLowerCase()==='box') target='BoxPlay';
      if(!target) return alert('Ugyldig kæde');
      matchSelection[target] = matchSelection[target] || [];
      // avoid duplicates
      if(matchSelection[target].some(m=>m.idx===playerIdx)) return alert('Spilleren er allerede i denne kæde');
      matchSelection[target].push({idx:playerIdx, pos:'C'});
      renderChains();
    }
    window.removeFromChain = function(ci, playerIdx){ const c = chains[ci]; matchSelection[c] = (matchSelection[c]||[]).filter(m=>m.idx!==playerIdx); renderChains(); }

    document.getElementById('openMatchBtn').addEventListener('click', ()=>{ renderMatchAvailable(); // reset selection
      // initialise empty selection
      chains.forEach(c=> matchSelection[c]=matchSelection[c]||[]);
      renderChains(); document.getElementById('matchModal').classList.add('show');
    });
    document.getElementById('closeMatchModal').addEventListener('click', ()=>{ document.getElementById('matchModal').classList.remove('show'); });
    document.getElementById('saveMatchBtn').addEventListener('click', ()=>{
      // collect positions
      const saved = {created:new Date().toLocaleString(), chains:{}};
      chains.forEach((c,ci)=>{
        saved.chains[c] = (matchSelection[c]||[]).map(m=>{
          const sel = document.querySelector(`#chainsContainer select[data-ci='${ci}'][data-idx='${m.idx}']`);
          return {player: state.players[m.idx].name, position: sel ? sel.value : 'C'};
        });
      });
      state.matches.push(saved); save(); document.getElementById('matchModal').classList.remove('show'); alert('Kamp gemt lokalt');
    });

    // helpers
    function renderAll(){ renderPlayers(); renderExList(); renderMatchAvailable(); }
    renderAll();

  </script>
</body>
</html>
